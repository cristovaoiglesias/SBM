using Flux
using Plots
using Distributions
using Turing
using StatsPlots
using Random
using CSV, DataFrames
using Dates


# these tutorials can help to understand this code
#  https://dm13450.github.io/2020/12/19/EdwardAndFlux.html
# https://turing.ml/dev/tutorials/03-bayesian-neural-network/








## NN with FLUX


function unpack(nn_params::AbstractVector)
    W1 = reshape(nn_params[1:20], 20, 1); #1x20
    b1 = reshape(nn_params[21:40], 20); #20

    W2 = reshape(nn_params[41:440], 20, 20);# 20x20
    b2 = reshape(nn_params[441:460], 20);#20

    W3 = reshape(nn_params[461:480], 1, 20);#20
    b3 = [nn_params[481]]

    return W1, b1, W2, b2, W3, b3
end

function nn_forward(xs, nn_params::AbstractVector)
    W1, b1, W2, b2, W3, b3 = unpack(nn_params)
    # nn = Chain(Dense(W₁, b₁, tanh), Dense(W₂, b₂))
    nn = Chain(Dense(W1, b1, relu),
                  Dense(W2, b2, relu),
                  Dense(W3, b3))
    return nn(xs)
end

#This Objetive function is the black-box function of this experiment
function BBF(xs,ys,nn_params::AbstractVector)
    W1 = reshape(nn_params[1:20], 20, 1); #1x20
    b1 = reshape(nn_params[21:40], 20); #20

    W2 = reshape(nn_params[41:440], 20, 20);# 20x20
    b2 = reshape(nn_params[441:460], 20);#20

    W3 = reshape(nn_params[461:480], 1, 20);#20
    b3 = [nn_params[481]] #reshape(nn_params[2337:2368], 1);#1

    mlp = Chain(Dense(W1, b1, relu),
                  Dense(W2, b2, relu),
                  Dense(W3, b3))
    x_pred=mlp(xs)
    l=Flux.Losses.mse(x_pred, ys)
    return l
end

# generate the training DT
f(x) = cos(x) + rand(Normal(0, 0.1))

xTrain = collect(-4.75:0.02:1.7)
yTrain = f.(xTrain)
plot(xTrain, yTrain, seriestype=:scatter, label="Train Data")
plot!(xTrain, cos.(xTrain), label="Truth")


# x=xTrain[[Array(1:1:180);Array(150:1:200);Array(280:1:323)]]
# y=yTrain[[Array(1:1:50);Array(150:1:200);Array(280:1:323)]]
x=xTrain[[Array(1:1:180);Array(280:1:323)]]
y=yTrain[[Array(1:1:180);Array(280:1:323)]]
y=[0.09722211392807228, 0.09436825064595704, 0.1564893407890332, 0.002830538986625924, -0.021517349209385216, -0.07002914740947393, -0.24869803382838085, -0.013714626010641509, -0.11867042226165472, -0.1344040064722682, -0.3005850775873382, -0.20233026119097164, -0.1700073065706301, -0.16359296541015508, -0.39493010168048814, -0.42535234925558085, -0.2145716975320166, -0.40074089518296147, -0.3249179125621875, -0.3434451193689504, -0.4210476123139251, -0.2183310437678922, -0.3576765660747292, -0.19401248139473998, -0.3734738423689974, -0.513360797057985, -0.4319489517865463, -0.5768534268245386, -0.5031443374337723, -0.6121063102476376, -0.6512583447936272, -0.6527161299771692, -0.5783575686857442, -0.5958660626917058, -0.670584930055507, -0.7822918904198397, -0.5453413484054292, -0.6421558908021956, -0.6680948867214174, -0.7869010785255073, -0.7202188404215857, -0.9890859377080665, -0.740741766215126, -0.6469781463608849, -0.6511995902254962, -0.8198949385971992, -0.6574882871459912, -0.8725453148500457, -0.7096862832510955, -0.8637311266773278, -0.8795473492696998, -0.8751600303305958, -0.7791980890661846, -0.7424684785407942, -0.7809977391550109, -0.9699138286528701, -0.8696683311772968, -1.0757344538174678, -0.9083450117630174, -1.0418340380584086, -0.8569821894392438, -0.8930894497559589, -0.8448567942113069, -0.9267721884576814, -0.8682798311122498, -0.9080694221888203, -1.0784710375141247, -0.8750055461619332, -1.0268767354024702, -1.0374392732784712, -0.7600662778821382, -0.9472337446140018, -0.8560738166681852, -1.0595974174785312, -1.1917449967161264, -0.8902603662987002, -0.9816734795670936, -0.998521426320988, -1.0605756011718754, -1.0162560183654379, -0.7397813105655939, -1.0631756442532616, -1.1092693289938418, -1.082020337511113, -1.0403731890843728, -0.9781136603352454, -0.9699486329366075, -0.8988255663712261, -0.8747123403571915, -0.9037415002240535, -0.9898239566998631, -0.9815580994175476, -1.0067320626875373, -0.8682635109961128, -0.9733829573929912, -1.104277163610248, -1.0340997365685318, -0.916848963657304, -0.8987223937434501, -1.0350967181731228, -0.7933933930283771, -1.0324593923227017, -1.043456234284624, -0.9080639627983665, -0.7195742665638848, -1.0234174133457565, -0.7925943530150676, -1.176920413891036, -0.9213548221091218, -0.7762938237260427, -0.89949335759924, -0.8859154110891104, -0.764273038103864, -0.6765895819492037, -0.5972163883184931, -0.8696348479659781, -0.8484445070976993, -0.8157506777456894, -0.6524457702259706, -0.738100979164984, -0.6958710936072312, -0.6526644694171282, -0.6033771229201793, -0.5425401421273286, -0.8627108901359564, -0.7060208866794638, -0.4698652654995257, -0.672241121154513, -0.4343814484177865, -0.5735717753171342, -0.5401252793150698, -0.7066155285395836, -0.4206363294404199, -0.4589690857868283, -0.40199676017653674, -0.3727433749907105, -0.5334933764569185, -0.4250419317894505, -0.32965252284093804, -0.34503102811380476, -0.3935539261983544, -0.40220680676460646, -0.1957085214674409, -0.3843604630928206, -0.36507747250176303, -0.1524630268537458, -0.46067816438330195, -0.5618567321288572, -0.15622248391119486, -0.11123407604228, -0.0977701184441494, -0.1672580082411704, -0.19211396775739673, -0.05736440732103794, -0.03943965428145947, -0.1449331439443644, -0.20484344269044444, -0.24794465830433093, -0.11805021203830274, -0.0145471535937882, 0.16305098039375565, 0.0922604041806031, 0.06303118944188878, 0.2225434483498072, 0.15224617393729503, 0.20694232486479847, 0.01698238317533493, 0.12342777323722337, 0.1126611724307766, 0.2261878177430221, 0.34909059550480886, 0.19019147032853823, 0.22469454577869996, 0.124279222073342, 0.3736681821980766, 0.14378571668631934, 0.4309240015346088, 0.23971560952304666, 0.5430743759970067, 0.6010354904998758, 0.5843390742579551, 0.590633599915273, 0.5867642762627886, 0.7582583222465599, 0.593356540095791, 0.42445390799415883, 0.6752860672768497, 0.4797268061563687, 0.6134870165024982, 0.6538769186903366, 0.5716616555074083, 0.5362350001884428, 0.4982574060043867, 0.5211946761179199, 0.5168419204447771, 0.433009236272448, 0.4692617634557157, 0.3967490661224979, 0.37897526710317864, 0.3823453317429101, 0.42586063519508843, 0.1908392294944507, 0.23702457060812707, 0.30538364810995516, 0.31169719597891693, 0.2989417915938425, 0.1077407804533633, 0.19294488858745762, 0.24044497493384476, 0.2755724328965718, 0.12814929537549336, 0.08874817099477915, 0.12129131185304687, 0.06589516387321696, 0.02387359971935208, -0.14450350497995235, 0.07499506178313195, -0.04793878866396995, -0.07064840274676704, -0.07761203068461411, -0.04649858978285776, -0.06512363003656521, -0.17989757685841204, -0.06157870191421286]

estimated_params=[]
all_min_v=[]
print(estimated_params)
ppp=plot(x, y, seriestype=:scatter, label="train Data")

# for i=1:1000
#     model = Chain(Dense(1, 20, relu),
#                   Dense(20, 20, relu),
#                   Dense(20, 1))
#
#     function lossMSE(x, y)
#         l=Flux.Losses.mse(model(x), y)
#         # println(l)#," ",Flux.params(model))
#         return l
#     end
#
#     # optimiser = Descent(0.1);
#     optimiser = ADAM();
#     train_data = Iterators.repeated((Array(x'), Array(y')), 10);
#     Flux.@epochs 250 Flux.train!(lossMSE, Flux.params(model), train_data, optimiser)
#
#     xTest = sort([x;collect(-7:0.1:3.5)])
#     yOut =  model(xTest')
#
#     # ppp=plot(x, y, seriestype=:scatter, label="train Data")
#     # plot!(x, y, seriestype=:scatter, label="train Data")
#     plot!(xTest, cos.(xTest),c=:lightblue, label=false,w=4)
#     plot!(xTest, yOut', c=:red,label=false,w=4,alpha = 0.5)
#     display(ppp)
#
#
#     parameters_min_v=[Flux.params(model)[1][:];Flux.params(model)[2][:];Flux.params(model)[3][:];Flux.params(model)[4][:];Flux.params(model)[5][:];Flux.params(model)[6][:]]
#     append!(estimated_params,[parameters_min_v])
#
#     min_v=BBF(Array(x'), Array(y'),parameters_min_v)
#     println("Minimum value of BBF: ",min_v)
#     # println("Parameters of Minimum value of BBF: ",parameters_min_MLP)
#     append!(all_min_v,min_v)
#
# end

# 1000 min_v
all_min_v=[0.009470921683100172, 0.009915670967283994, 0.009059485503738892, 0.009672537188321674, 0.009698681270611425, 0.010618573095218868, 0.009415630454882206, 0.009650380382886816, 0.009652973531169149, 0.009383765532146154, 0.009436375834694552, 0.009241750544660518, 0.009685322110298102, 0.009317043020058202, 0.009727983251102315, 0.009286046992548164, 0.009451639630415341, 0.009725506594470381, 0.009523914012488283, 0.009651673360798921, 0.00932640024891643, 0.009336123233254142, 0.009514771820861107, 0.009353362498913498, 0.009354690354968, 0.009329298574441609, 0.009386911336176654, 0.009430653611743474, 0.00931017193021936, 0.009379227138567425, 0.009332799974367052, 0.00929859045609526, 0.009433004142168782, 0.009426381645712235, 0.009410578386599932, 0.009340270337111567, 0.009714654469447928, 0.009310374807953006, 0.009368131288312235, 0.009568702463865797, 0.009484661640081191, 0.009430314353774543, 0.009405611658952583, 0.009268921623472147, 0.009646126840222518, 0.009428773767122537, 0.009392529365920095, 0.009325499146485172, 0.009243982714180202, 0.009222430063351944, 0.009394694015043958, 0.012536606108516325, 0.009605593253992312, 0.009782217008827527, 0.009324014851426494, 0.009520505328118848, 0.009458775536246087, 0.012428497465933745, 0.009412498121941587, 0.00907269895629143, 0.00925627679491094, 0.009304329184855232, 0.009258732871630839, 0.009274954882232418, 0.009239397624882737, 0.009580408364973253, 0.009529591022852139, 0.009325397823141703, 0.00939859214954962, 0.009253630672341086, 0.009312283476644657, 0.009421142257407518, 0.009894574827311195, 0.009344603980761727, 0.009558603710376893, 0.009775529273924392, 0.009552988692251631, 0.00930680020014934, 0.009423683347459326, 0.00946765986123813, 0.009805590671948427, 0.00928976597452325, 0.009381241128509996, 0.009356685313744966, 0.00955195661663562, 0.00923637054902684, 0.009558110830886809, 0.009249897936064594, 0.009401532731325369, 0.009248915944232562, 0.009471751969816117, 0.00928256025073039, 0.009275287992582868, 0.009349767014763127, 0.009349528115805866, 0.009335547067286032, 0.009601305373685295, 0.00928119373973738, 0.009899497992262127, 0.009172198745683565, 0.009227524676252237, 0.009781693585415406, 0.00929973185911563, 0.009643541590672242, 0.009340735625615678, 0.00933440159229841, 0.009183009141800457, 0.010307026237769454, 0.009511259172984612, 0.009262765594868909, 0.009297151846664532, 0.009365522304855095, 0.009300119448033214, 0.009339508227408862, 0.009254264105070872, 0.009560795937962555, 0.00944825569331468, 0.009418223960052647, 0.009721117468098365, 0.009217629556380254, 0.009257977254731067, 0.011393686617923981, 0.009347220623645775, 0.009275107270323086, 0.009365206789832825, 0.009270027460758152, 0.009135178471734338, 0.009485371477286635, 0.009327591605439096, 0.009671498773406808, 0.009296474918703553, 0.009729172250038536, 0.009192995257819123, 0.00934875348146197, 0.00936147065937457, 0.009643773602651009, 0.009458098736215757, 0.009509154120310708, 0.009596328958326612, 0.009227577170912696, 0.00936077525571843, 0.009431159483801748, 0.0093380363833052, 0.009440889783262508, 0.009337217516875957, 0.009362675697718991, 0.009171352163893478, 0.009426494749224976, 0.009242594533413317, 0.009272231725657934, 0.009751926540892618, 0.009282298930929278, 0.009360668349810588, 0.009511311872404702, 0.00921386488954588, 0.0094693829077725, 0.0092301368740036, 0.009288730456702103, 0.009256514374204787, 0.009429428148099524, 0.009402223993273506, 0.009554170090352244, 0.00936423501567381, 0.009431913704591061, 0.009469987441331354, 0.012257385729687539, 0.009276488166124445, 0.009613588289846806, 0.009376251664180591, 0.009362762326785918, 0.009302109238369263, 0.01013259174377665, 0.009399959249193124, 0.009303581999358069, 0.009321412795115874, 0.010887457311471926, 0.009419050793520577, 0.009372762977447439, 0.009341792414429928, 0.009347213365431328, 0.00938294127701331, 0.009492631158597479, 0.009402488104443782, 0.010459459366222707, 0.0094091123374304, 0.00928239311491481, 0.009150661716503876, 0.0099474798087899, 0.009490061709155397, 0.009575943071681131, 0.009314483212574581, 0.009836993281088311, 0.009274487245433546, 0.009210580067773247, 0.009228647280776997, 0.009386491524687747, 0.009771144239685193, 0.009260267226428892, 0.010388338265972314, 0.009955116364371894, 0.009317129369894555, 0.009282804996975886, 0.009230161317823504, 0.009457073745019631, 0.009349166142124847, 0.009315855853226543, 0.009219220907755506, 0.009257725451693512, 0.009263852788184162, 0.009476775702867072, 0.009575282783923614, 0.009437950356628007, 0.00932326659609926, 0.009323535297595357, 0.00937932269920359, 0.009794785260214807, 0.00927610417710684, 0.009461581174187429, 0.009565756282223144, 0.00937122766739962, 0.009288131936981147, 0.009501680485356503, 0.009343838110498015, 0.009617740378348198, 0.009675840670518921, 0.00949433812968051, 0.009403535010272041, 0.009314386768227101, 0.010194057464292628, 0.00938015161783605, 0.009288283099152361, 0.009451639366640702, 0.009337231175901324, 0.009419885451813806, 0.009734301848051366, 0.009276437225139522, 0.009236375782396295, 0.009331318888518186, 0.009375434940588349, 0.009328575712086251, 0.009382135965285499, 0.009266479191467456, 0.010657581780633585, 0.009319856773288514, 0.009527212837570022, 0.009273649281546628, 0.009554774453349917, 0.010321339237468271, 0.00942744231454821, 0.009330769575339909, 0.009644218011044373, 0.009553014385226172, 0.012684335341081845, 0.009334680199984268, 0.009652006456354103, 0.009215158582543818, 0.009151206342720337, 0.009393164647034812, 0.00975886497886773, 0.009261302620734681, 0.009303024910507593, 0.009262494785563761, 0.009323925697641703, 0.00943421625278347, 0.009310200272820365, 0.009325197509728492, 0.009727051236154447, 0.009322270388455952, 0.009630138906788339, 0.009750079824908083, 0.00946472341271638, 0.00945001198336257, 0.009549255730186525, 0.010088107397029545, 0.009564887965462902, 0.009357257142909496, 0.009472617246994757, 0.009389884100957436, 0.12423816593184844, 0.009261258922420674, 0.00961616201982692, 0.00929651372260433, 0.057902140446384455, 0.00938902657923293, 0.009719816159803708, 0.009642015502927646, 0.00943100064837679, 0.009550615143743056, 0.009474505515811332, 0.009298711650411894, 0.009352815793723792, 0.00966802526819697, 0.009421410653577532, 0.009378905876290063, 0.009494122572839242, 0.009269941674875872, 0.009430952636900154, 0.009346744959070575, 0.009325150997657157, 0.00937891536798832, 0.009471059860115191, 0.009388438291997645, 0.00934059015153778, 0.009673455336424287, 0.009545795969560286, 0.00964133548118465, 0.009335917407920086, 0.009350814036312171, 0.009368319427760197, 0.009413670437428957, 0.009460207083999958, 0.009242431680556256, 0.009255533224013358, 0.009269393166578882, 0.010125615121189162, 0.009289775469201664, 0.009339990621083668, 0.009312734348045816, 0.009328108961817587, 0.009624599405721941, 0.009439042919410267, 0.009563268093068376, 0.009291864651141945, 0.009174790924585794, 0.009437216009084483, 0.009339210105740053, 0.009428469850178993, 0.00927076609413374, 0.009017338985908641, 0.009502835788998059, 0.009277313191635548, 0.009448243811112528, 0.009285935305374795, 0.00954184105682743, 0.009316729042773076, 0.009847260328246819, 0.009558530796363126, 0.009758688274068185, 0.010015688431473253, 0.009238374636183969, 0.009556095980755215, 0.009459330306431752, 0.009288532852251678, 0.009291073348914687, 0.00963205380028093, 0.009344375065335099, 0.009764554226758945, 0.00933895559126868, 0.00939558287552633, 0.009601198772657695, 0.009389382225729217, 0.00929913706344698, 0.009236956791269452, 0.009268509617513168, 0.009910304160205776, 0.009314914790860355, 0.009251888494286362, 0.009339023290258739, 0.009430958068138146, 0.009475069466856877, 0.009943783200888656, 0.009260306300073023, 0.009315080849382987, 0.009277026590934883, 0.009426140278814384, 0.009294817682859781, 0.009545921439290186, 0.009972913984239143, 0.009874465382705245, 0.009528547508076763, 0.009261799595347517, 0.009254646817950758, 0.009259311592704858, 0.009396492279103955, 0.009313472806912087, 0.009381456638052335, 0.009391895475428168, 0.010025717165603897, 0.009435102106036843, 0.009894436898626055, 0.009349857958447547, 0.01976904832783628, 0.00980597210847464, 0.009371922124260768, 0.009222735898146563, 0.009154302981634542, 0.010151764731733362, 0.009642320638931461, 0.009264843938238964, 0.009611200898175081, 0.009367884998224784, 0.01053083271462259, 0.009191415916627647, 0.00922951750044448, 0.009265755221326829, 0.009618664825583118, 0.009603290601410198, 0.0091290148186809, 0.009545525923320183, 0.009388375751020538, 0.00936628210443784, 0.00923926150645263, 0.00926785428545472, 0.009336409486760821, 0.009548790169659623, 0.009381400465051674, 0.009565538837364985, 0.009583043589728644, 0.009592850580269355, 0.009181205906325221, 0.009483234223817647, 0.009264380379226065, 0.009489440432136339, 0.009344087711557517, 0.009387170193698873, 0.009455675093716465, 0.009555939302333867, 0.009388191795489503, 0.009426993532837864, 0.009877846274048177, 0.009338820859240994, 0.009290183730959186, 0.00950182838431456, 0.009621160963076277, 0.009608762101850325, 0.00931449906685006, 0.009433603161393704, 0.009393702547064857, 0.009936269173648567, 0.011310228991672845, 0.009287269089904885, 0.009492500323612743, 0.009283374690629672, 0.009433220176537046, 0.00934238767639404, 0.009572012443694973, 0.009137749371101261, 0.009535180096407114, 0.009286960389223314, 0.009386572836552346, 0.009355611588393872, 0.009524233446413106, 0.009179406264105969, 0.009746447893102287, 0.009324985430734428, 0.009289007892228768, 0.009733265553582515, 0.010412372779032774, 0.014480994374930656, 0.009414019188117387, 0.009448593938819966, 0.009219397225323786, 0.009599150147868477, 0.009346387632132715, 0.009791885596840133, 0.009560691508473291, 0.009796127162878612, 0.009204528117819744, 0.00934276834691641, 0.009900287110985326, 0.009328669600322076, 0.009197208402577534, 0.009224118518232852, 0.009299314567193928, 0.00984159032316824, 0.009625545679107572, 0.009310039280897171, 0.00925864368956213, 0.010133555334184382, 0.009460644068132138, 0.009543715760350647, 0.009375084493939732, 0.009304351422524072, 0.009697441879696357, 0.009258215233756667, 0.009500170994284964, 0.009250117299366421, 0.00930804924437765, 0.009453949948241086, 0.009773992887166566, 0.009403715968127894, 0.009343411323566147, 0.009415234698126372, 0.009270027030553777, 0.124241634718782, 0.009568502072126448, 0.00967219222666942, 0.009343722747451587, 0.009396900198799466, 0.009298165128345942, 0.0095469851211981, 0.009356198165088116, 0.009228393261176028, 0.0093864236473088, 0.009482939143180267, 0.009384857805431133, 0.009583685297893085, 0.009495343624814958, 0.009516432021642719, 0.009583054515120279, 0.009317196098102299, 0.010075925848324715, 0.009147086235805735, 0.00954962943573655, 0.01050004842357689, 0.009318402347566226, 0.011040398091002584, 0.009414395586002421, 0.00941325837765324, 0.009492930962661116, 0.009162664284305972, 0.009264815901330664, 0.009349341732095078, 0.009274432566592727, 0.009320570569974733, 0.009489901754546512, 0.009134867419740405, 0.009634111954964735, 0.009229305177771697, 0.009387956893582638, 0.009456496181003943, 0.00965219053721675, 0.009414062037984386, 0.009350562893895673, 0.009272962310007491, 0.009538273253132447, 0.009495447967005658, 0.009254130973496583, 0.009784020838714243, 0.009471466485166792, 0.00931695687323593, 0.009524257193257616, 0.009468630197572533, 0.009323598348096958, 0.010003230658067573, 0.009016648341714508, 0.00924660040592823, 0.009301469913008715, 0.00925479496728294, 0.01059087330883636, 0.009336071033375665, 0.009364411570086925, 0.00922318754646864, 0.009504252698876118, 0.009288811421246131, 0.009641064679557498, 0.009243675503848078, 0.009434773755215934, 0.009756518028212062, 0.00924814809281561, 0.009271962152046741, 0.009563446521323746, 0.0096895092977305, 0.009322762856822875, 0.009362724092911404, 0.009418760367793363, 0.009330381473873993, 0.009576887332570486, 0.009395531189134271, 0.009815704952657494, 0.00928252081595765, 0.009370800877878106, 0.009587651033918202, 0.009330929989468629, 0.009348745999411118, 0.009283176716466923, 0.00985851821913741, 0.009202230931789084, 0.009570867264810797, 0.009373289307531391, 0.009802916078050694, 0.009557158046743135, 0.009493669843836608, 0.009410771068496726, 0.009285384046341388, 0.009429102293513725, 0.00989431140067136, 0.009687486543360577, 0.00967601354864687, 0.009555343235185339, 0.009266553287191406, 0.00933288312033343, 0.00989901792546032, 0.009287584017444171, 0.009494728885460284, 0.009298193964426325, 0.009491314731992205, 0.00929320885705322, 0.009140725180809158, 0.009494678421156961, 0.009767064276843217, 0.009434701636305946, 0.008883137955486516, 0.009450875351214765, 0.009489317150041419, 0.009462146360855347, 0.009376707148508422, 0.009204620109179995, 0.010102045886461426, 0.12424467212078516, 0.009852614962398698, 0.009280301633181987, 0.009294934317967305, 0.009478266435710385, 0.009354537334595904, 0.009344258583167554, 0.009649573390691798, 0.009317517449275368, 0.009382843111523513, 0.009316699446821538, 0.009522292315518556, 0.010218691747280323, 0.009393673050548843, 0.010095361219920718, 0.009837419862975741, 0.010104404831186969, 0.009262733469418487, 0.009300829410373758, 0.009282256529486579, 0.009222909250935487, 0.009370882158441191, 0.009658820894714046, 0.009528162908114231, 0.009335993417671046, 0.02478197889237933, 0.009920402815836971, 0.009334697378552958, 0.00930254822182684, 0.009307452500504475, 0.009319700869973187, 0.009795084811887894, 0.009311544787951135, 0.009280948940066421, 0.009476736438420204, 0.009326488717545486, 0.009374407643180163, 0.009246884080243089, 0.011355420332790004, 0.00932236829175102, 0.010578257699563125, 0.009463412557696772, 0.00954572690012513, 0.009575814891932462, 0.009368111690896677, 0.010495334674443663, 0.009319816578080769, 0.009405510318305268, 0.009392101081787665, 0.009558375536711166, 0.009745822738264026, 0.009723330215937175, 0.009446180816869727, 0.017328545046261183, 0.009291763114438117, 0.009259988475271286, 0.009585324619671872, 0.00954358709475167, 0.009302092245126726, 0.009590697386394011, 0.009309295684441695, 0.009600617276074494, 0.009642875561853972, 0.009362654943779745, 0.009419962922490518, 0.009336707337964522, 0.009215775017466982, 0.009327540055838262, 0.009300235314350296, 0.009509118249633316, 0.009403237916643525, 0.009828412898347043, 0.009090832824631018, 0.00932931074904616, 0.011038700619969335, 0.00960477541937642, 0.00995958304739893, 0.010255547817304854, 0.010279601965048683, 0.00936826168722583, 0.009341137186156692, 0.009431408096275339, 0.00953806639840181, 0.009533041998970556, 0.009684668452678565, 0.010525312289132746, 0.009325712339675064, 0.009400704194273399, 0.012413547995288791, 0.009348727172369587, 0.009796645011622309, 0.00954841626346274, 0.00922245133325202, 0.009210807462248848, 0.009287062063220471, 0.00916301836434309, 0.009350995146278407, 0.009638429113065379, 0.009545256934396945, 0.009286231142120177, 0.010065445052853146, 0.009335219841553135, 0.009540447654433399, 0.009500579464337956, 0.12423522449332487, 0.009280757660739594, 0.009589149868358857, 0.009316783124505628, 0.009477750353007037, 0.009901628037656146, 0.00957547174875477, 0.009992076832275851, 0.009423261199264784, 0.00978288886299534, 0.009305841150839097, 0.009869805290726452, 0.009360537480876853, 0.01076259047732323, 0.009951861636186861, 0.009365431338844205, 0.009369719908752532, 0.010445486001225236, 0.009369823125464546, 0.009656758637630564, 0.009273642643081297, 0.009205247837274638, 0.009232627500062653, 0.009782144815802737, 0.009860834332052143, 0.009936687542383497, 0.009262955782293542, 0.00960975904626144, 0.009453253753677223, 0.009469893359650688, 0.00972986214867569, 0.009245591881277682, 0.009392697389017591, 0.009328970307719503, 0.01009462825470441, 0.009443983969669155, 0.009382137510042823, 0.009298872092775556, 0.009607936584630602, 0.009349740333461186, 0.009664588709622762, 0.009246600331793694, 0.009318358535825858, 0.009381672428816799, 0.009367933413720043, 0.009269761800404749, 0.009308369425898997, 0.009396057919272522, 0.009299576085511293, 0.009310068347465826, 0.010065833940539438, 0.0094619712160405, 0.009284916353219746, 0.00949377568213455, 0.009389768411148353, 0.009673747302199536, 0.009347207965413355, 0.009325934923518986, 0.009477445521384381, 0.009292855450880965, 0.011710085461189679, 0.009318147134033181, 0.009430811678573067, 0.009575899174273763, 0.009290619229693783, 0.009321230429505513, 0.009341583718558885, 0.009505884276409774, 0.009963784096624068, 0.009359289491790589, 0.009305741671897221, 0.009758963505830536, 0.009344598814300688, 0.009307131965114412, 0.009420597709506909, 0.009682221411225392, 0.009587350499868195, 0.009413310139006795, 0.009121270940599792, 0.009122880440020147, 0.009596000170829103, 0.009435649523274251, 0.009651510794157008, 0.010707329896686579, 0.009486639631199362, 0.009329561887972227, 0.009486555981761794, 0.009367142738151204, 0.009737959206000017, 0.009478575062052602, 0.009249317213669074, 0.00932092936747271, 0.009525189768797366, 0.009257766666588268, 0.009291316599495652, 0.009655488295300612, 0.009421707072227207, 0.009550091791370926, 0.009329334406983676, 0.009232531236606467, 0.009297511494424787, 0.009271984681969075, 0.009411876349034407, 0.009429201701738629, 0.009324401988787366, 0.009277097103069306, 0.009458645813647793, 0.009250808001730873, 0.009638067887383528, 0.009442288397482037, 0.00932783802759483, 0.009250387867879673, 0.009398539439719493, 0.010391233662280466, 0.00956152912244371, 0.009262845541172857, 0.009167842745826429, 0.009416338551536424, 0.009411137532187431, 0.009349249713263537, 0.009646294887393745, 0.009248241252292844, 0.00920800413700644, 0.009715784721338919, 0.009323629465797314, 0.009419932504405426, 0.009389282047950611, 0.009320376403598977, 0.0091386514547485, 0.009264420894384558, 0.009187026921829334, 0.009333041697410933, 0.009320245936504167, 0.009492430384922776, 0.010692093304616904, 0.009388072825015721, 0.009478276126359587, 0.009109594250142697, 0.009583328328509754, 0.00973535006998152, 0.009744998995930284, 0.009976317632606911, 0.009315501083524937, 0.009357546124489788, 0.010279801049011082, 0.009667320819009692, 0.009349704607106792, 0.009336001096605696, 0.009260025451891635, 0.009460423982362241, 0.009421982646380075, 0.009373258035776754, 0.009267385365951605, 0.010418197387907684, 0.009487015214259925, 0.009309363972931762, 0.009478355053384648, 0.00940862668906244, 0.00934093626173412, 0.009248444770927075, 0.009296060236319485, 0.00945018326991288, 0.009205879593857545, 0.00944471516870564, 0.009476244051533125, 0.009387049726785515, 0.009451136842321411, 0.009279723276795987, 0.010473110432585328, 0.009594458759535499, 0.009283566919065485, 0.009372857451487897, 0.009807176292374322, 0.009710076061931644, 0.009651789895462674, 0.009246168797248062, 0.009459599268567766, 0.00934727213705606, 0.009570781344325208, 0.009895493735248059, 0.009332701576673045, 0.009691627798992632, 0.009236892618132264, 0.00929897601232844, 0.009570560632738648, 0.010014275832213024, 0.009597724022356884, 0.009313731680690324, 0.009395964055872204, 0.00923796722952099, 0.009558704831698597, 0.010214671761890202, 0.009251803685968419, 0.009501062890365, 0.010382920388057427, 0.009348797069647601, 0.009251297774278458, 0.009312214972857816, 0.009356149496565592, 0.009544354475503171, 0.009245817332184814, 0.009566809608412538, 0.00979290169058132, 0.009481160525120422, 0.00936461016817353, 0.009440811730638208, 0.009240060523515838, 0.009267781122833676, 0.009263765894139549, 0.009471033709683453, 0.009406730192024326, 0.009351018539661195, 0.009359398608583388, 0.009274800589843462, 0.009379627087976222, 0.009331396407449623, 0.009797440403759534, 0.00949156234325813, 0.00928984287825738, 0.014546245910534874, 0.00977688271855218, 0.009414282366338922, 0.009359539065922379, 0.009248559138979014, 0.00933140820481487, 0.010384471198392595, 0.009387574324549465, 0.009596179551384, 0.009877635923543586, 0.009335354163725409, 0.009487212735512878, 0.010514305576847837, 0.009349163162001198, 0.00930415789061051, 0.00929909359608788, 0.009273047099582597, 0.009451161591309657, 0.009343065593283961, 0.009392684978890514, 0.009279988883387612, 0.009589826376112937, 0.009270535906282587, 0.009466761942549445, 0.009436169944264003, 0.00945291803384994, 0.009286846869085761, 0.010270319127882234, 0.009623185894046088, 0.0094654701504131, 0.010384196125905215, 0.009983076040138542, 0.009508291834115317, 0.009281317768874387, 0.009420092116846194, 0.009438103271108108, 0.009668367299180419, 0.009478188610356418, 0.009321541560326737, 0.009572616124061722, 0.009400535806193138, 0.009183365348592478, 0.009145121293232071, 0.009457065921024865, 0.009531571297742457, 0.009213589479417151, 0.009218489267848493, 0.009350268023381165, 0.009449622237075354, 0.009447013853234754, 0.009312157201012162, 0.00954254851874296, 0.009260146055320636, 0.00945644110595815, 0.009306880399606369, 0.009247824372736779, 0.009687901764849138, 0.009266806478389244, 0.009416460170834081, 0.009554409436999367, 0.01001311859280664, 0.009649390486162701, 0.012023220882801328, 0.00947169701900341, 0.009659374239321101, 0.009536432901217085, 0.009700636306507941, 0.009338482404095847, 0.009676675032788556, 0.01016739032895896, 0.009276895036178215, 0.009316969689541781, 0.009473307884230503, 0.009521096772332534, 0.009323548976267613, 0.00947942152438838, 0.009228709581720774, 0.009290935450610379]

# julia> mean(all_min_v)
# 0.01001266167068886
#
# julia> std(all_min_v)
# 0.007275674997536233

# mean of 1000 estimated parameters
mean_est_params=[0.003769907, 0.014439038, 0.010553066, 0.023710001, 0.020747747, 0.028370542, 0.02201215, 0.024288159, 0.04671534, 0.021253912, 0.039407417, 0.053608127, 0.012351649, 0.046353456, 0.053207237, 0.031034756, 0.030525614, 0.029548952, 0.04155388, 0.008078082, 0.03977036, 0.036179416, 0.02470332, 0.022113, 0.02424442, 0.036687102, 0.034942083, 0.031123541, 0.04111245, 0.03732798, 0.037791483, 0.041799936, 0.040831283, 0.036572758, 0.043699022, 0.035035145, 0.055797964, 0.03602898, 0.024454053, 0.032253906, -0.009942664, -0.0027037694, -0.017967615, -0.005836256, -0.018148538, -0.0019516661, -0.014001255, -0.04940575, -0.035913732, 0.0057986635, -0.034204695, -0.010245334, -0.0144265415, -0.022653894, -0.029557599, -0.035876527, -0.00563956, -0.012167966, -0.02794562, -0.014110035, -0.014845151, -0.02411513, -0.011330761, -0.011815085, -0.010911187, -0.020138644, -0.012172019, -0.014106922, -0.0010396864, -0.029434076, -0.032381408, -0.015846934, -0.035485197, -0.019829918, -0.033362646, -0.022305923, -0.0028585473, -0.018123044, -0.015833773, -0.0071268, -0.021387674, -0.031062195, -0.02226932, 0.002788928, -0.023356168, -0.024134869, -0.033629306, -0.022054441, -0.013639348, -0.026242906, -0.014368376, -0.019632624, -0.017762229, 0.001082215, -0.035868984, -0.016232457, -0.0020312287, -0.026939195, -0.007254027, -0.020192962, -0.009210779, -0.02542524, -0.027186533, -0.01088002, -0.003947829, -0.010209665, -0.022081776, -0.02075373, -0.0138099175, -0.01806709, -0.011439876, -0.019849433, -0.023442928, -0.034320444, -0.024027012, -0.0077399397, -0.01999981, -0.010448964, -0.029017018, -0.013925198, -0.011686609, -0.020758698, -0.010571496, -0.0008505527, -0.006618912, -0.0457818, -0.008950089, -0.017738998, 0.002527741, -0.01669594, -0.010063735, -0.021819245, -0.02374241, -0.007812067, -0.036269303, -0.014817213, -0.008909205, -0.021530328, -0.009180091, -0.01980669, -0.01400128, -0.009974903, -0.01261155, -0.01644803, -0.020276641, -0.018429885, -0.0041425484, -0.012391433, 0.0019407354, -0.01377783, -0.012704265, -0.007910034, -0.008091385, -0.01728118, -0.0060801203, -0.0135557735, -0.031372912, -0.011563236, -0.009900652, -0.015233602, -0.011879374, -0.00909937, -0.012087932, -0.018291123, -0.03495948, -0.015805988, -0.014372511, -0.031178784, -0.013616886, -0.008829265, -0.00940401, -0.01959379, -0.029645568, -0.019132806, -0.007917062, -0.019563347, -0.024860168, -0.004516694, -0.02806073, -0.01022728, 0.0033338778, -0.014696162, 0.0071160523, -0.0058557214, -0.013156595, -0.019557064, -0.021696305, -0.0033870537, -0.026036246, -0.024786782, -0.016432606, -0.014844815, -0.014387225, -0.015528402, -0.018629977, -0.0074835084, -0.007358128, -0.019474648, -0.009590788, -0.016122783, -0.0064748046, -0.004325233, -0.022498973, -0.014421197, -0.0262616, -0.010031455, -0.016423617, -0.015547336, -0.02563008, -0.025834084, -0.015074732, -0.012096596, 0.0022181056, -0.014146184, -0.013343302, -0.01584876, 0.0013209445, -0.025294824, -0.0027509583, -0.016615178, -0.025130115, -0.02477474, 0.0076818876, -0.0077875243, -0.00742868, -0.023683652, -0.005379469, -0.017399479, -0.012307259, -0.018737111, -0.0070612, -0.011647489, -0.0119384285, -0.015079331, -0.006812937, -0.032512072, -0.003995072, -0.006251032, -0.01634493, -0.01011735, -0.0030188423, -0.0031762407, -0.020327989, -0.0009512491, -0.012939438, -0.018631693, -0.03675155, -0.022109797, -0.020390056, -0.00023370478, -0.017620698, 0.013142724, -0.020163821, 0.0025230742, -0.012739966, -0.028989924, -0.010833259, -0.02928558, -0.017059501, -0.016519813, -0.004445848, -0.025245054, -0.012471823, -0.0012815394, -0.028381445, -0.02317101, -0.004908676, -0.020681107, -0.021300964, -0.023060635, -0.018693076, -0.0032306144, -0.032258417, -0.021995116, -0.013433519, -0.011990914, -0.009887414, -0.012262625, -0.024268392, -0.025358943, 0.0050477413, -0.023386203, -0.008775031, -0.007562472, -0.037029628, -0.006761937, -0.03082717, -0.012815522, -0.017956533, -0.045303516, -0.007071302, -0.0023733375, -0.024640493, -0.010417449, -0.015512318, -0.01722595, -0.02176314, -0.02516997, -0.023318786, -0.014970012, -0.004767559, -0.028831067, -0.010045532, -0.0029622829, -0.0053311214, -0.005541101, -0.016403405, -0.020153716, -0.009252315, -0.026219916, -0.0057980786, -0.013233366, -0.018478852, -0.028801473, -0.021453183, -0.0037513429, -0.029645491, -0.005673237, -0.0043836595, -0.013443349, -0.020667741, -0.021293383, -0.028716976, -0.025033057, -0.03447357, -0.023359168, -0.005659594, -0.03032821, -0.026495393, -0.0011898648, -0.031116486, -0.017455738, -0.026936267, -0.0013861925, -0.012166981, -0.019812109, -0.010908941, -0.010619087, -0.0053329067, -0.021845259, -0.029804606, -0.01797792, -0.016789328, -0.026142783, -0.0035272613, -0.02123294, 0.004905709, -0.01694332, -0.02837316, -0.01967468, -0.027560571, -0.013540041, -0.012917955, -0.02511457, -0.0016785946, -0.0057363766, -0.023954237, -0.0012446336, -0.009776663, -0.026030404, -0.010779213, -0.007234318, -0.0034200638, -0.015019971, -0.02084999, -0.018681195, -0.020886013, -0.014983582, -0.018673487, -0.013444349, -0.009411923, -0.025591014, -0.030415934, -0.014168093, -0.014947745, -0.020397864, 0.004499713, -0.02797708, 0.011828699, -0.021376422, -0.0064877416, -0.003393631, -0.03804655, -0.029955763, -0.012322061, -0.015412789, -0.010204109, -0.026207395, -0.031440422, -0.009515391, -0.008880163, -0.02594694, -0.020049995, 0.008221506, -0.011851758, -0.03586622, -0.0125451, -0.016825842, -0.004840153, -0.025416404, -0.036314312, -0.011149388, -0.017887097, -0.018813577, -0.010719157, -0.009333945, -0.00735582, -0.03448136, -0.014963674, -0.012851104, 0.0023945237, -0.037018742, -0.030365074, -0.021181617, -0.0334307, -0.014559861, -0.015908264, -0.03224157, -0.034051955, -0.015475184, -0.014267606, -0.0076205987, -0.021660505, -0.0011414349, -0.009994123, -0.011954607, 0.0010765237, -0.024337405, -0.008923665, -0.017170334, 0.0003227232, -0.022970328, -0.011173259, -0.0046440763, -0.017334452, -0.012036256, -0.014639476, -0.01695859, -0.041287884, -0.011531291, 0.05813105, 0.051720448, 0.036833607, 0.04148804, 0.049439088, 0.03070075, 0.044169545, 0.058031138, 0.040487025, 0.04809406, 0.05240692, 0.038431134, 0.053480312, 0.036269195, 0.042972695, 0.040041313, 0.04651043, 0.047878597, 0.05461227, 0.053094856, 0.0038792412, 0.022491736, 0.016368434, 0.030040607, -7.917589e-5, 0.044625334, 0.004527094, 0.043132283, 0.029776495, 0.015657706, 0.035517864, 0.00671288, 0.0293584, 0.033447213, 0.021812437, 0.055979226, 0.028301029, -0.010621896, 0.0127514675, 0.03204273, -0.15191081]


# std of 1000 estimated parameters
std_est_params=[0.35685414, 0.36082187, 0.35980877, 0.35090747, 0.3514566, 0.34656906, 0.35451952, 0.354185, 0.3535339, 0.35425732, 0.35788998, 0.34876022, 0.3480024, 0.35430774, 0.35817045, 0.3514828, 0.34812093, 0.35386854, 0.3587451, 0.35527274, 0.32506114, 0.32527837, 0.322539, 0.32718843, 0.32896632, 0.32296574, 0.32982102, 0.311844, 0.31982693, 0.32964268, 0.3192664, 0.33891937, 0.33097804, 0.32704365, 0.33406144, 0.31689245, 0.31667712, 0.32815576, 0.3172071, 0.33113566, 0.30943668, 0.32993862, 0.30781683, 0.3117351, 0.33426222, 0.33951625, 0.3145134, 0.32155955, 0.3395949, 0.2928041, 0.3195736, 0.32993037, 0.3419678, 0.31564617, 0.32681644, 0.3361107, 0.30413577, 0.321121, 0.31622246, 0.32037735, 0.3175164, 0.3311975, 0.33598343, 0.3286392, 0.3047381, 0.32561076, 0.3262534, 0.3064699, 0.31750628, 0.33472317, 0.34026322, 0.3158233, 0.30396226, 0.29895037, 0.33819452, 0.32407168, 0.31499434, 0.32333517, 0.3257152, 0.31237108, 0.2999918, 0.32280177, 0.31774947, 0.31387368, 0.3213151, 0.3276724, 0.32262346, 0.31263414, 0.2892603, 0.29798993, 0.33372164, 0.3172317, 0.2942122, 0.3044878, 0.31249577, 0.31171706, 0.2981625, 0.2996319, 0.3197319, 0.29930148, 0.3108576, 0.31250226, 0.3307141, 0.2975008, 0.3168162, 0.33307984, 0.31642124, 0.3155077, 0.31052744, 0.32242516, 0.32121593, 0.31524992, 0.32379377, 0.3428908, 0.32583806, 0.31821537, 0.33040178, 0.29989025, 0.31756207, 0.30287352, 0.3294523, 0.31569135, 0.30540884, 0.32537705, 0.31623647, 0.32940137, 0.32160798, 0.3112053, 0.3073103, 0.3463009, 0.32367593, 0.3144297, 0.32224596, 0.33124363, 0.31340057, 0.31865132, 0.31101683, 0.33095282, 0.31347552, 0.29975855, 0.32293543, 0.3280218, 0.32700363, 0.32283238, 0.32328525, 0.30477542, 0.313428, 0.32136604, 0.31352383, 0.32001126, 0.3151419, 0.32347938, 0.31098047, 0.30899897, 0.32313085, 0.32325834, 0.3328631, 0.3246281, 0.30606696, 0.31326342, 0.3282091, 0.31608444, 0.30939344, 0.31031096, 0.31241852, 0.32955647, 0.33333468, 0.30798206, 0.30834553, 0.32020223, 0.3254731, 0.3323696, 0.3219344, 0.31030774, 0.29372212, 0.31478867, 0.3342924, 0.3211899, 0.3349648, 0.29997638, 0.31045112, 0.3404629, 0.30731478, 0.31726608, 0.29607987, 0.3305984, 0.32752165, 0.3199642, 0.32010138, 0.31803703, 0.32572573, 0.29692, 0.3266387, 0.32358032, 0.3170491, 0.32068118, 0.30099106, 0.30463946, 0.32532868, 0.3182417, 0.31845367, 0.33305615, 0.31967738, 0.327006, 0.35393953, 0.3275444, 0.31795254, 0.3288212, 0.32807314, 0.32423505, 0.31810424, 0.30665964, 0.33152685, 0.33034822, 0.32947695, 0.30741295, 0.320923, 0.32944077, 0.34871456, 0.32168838, 0.3325156, 0.3218654, 0.330818, 0.30445725, 0.31623667, 0.31528893, 0.30907214, 0.3257689, 0.31978825, 0.3193529, 0.31622288, 0.30699462, 0.31912214, 0.32127267, 0.3255769, 0.35071746, 0.32788718, 0.3352419, 0.308696, 0.33046907, 0.32427296, 0.32317942, 0.31530848, 0.32430267, 0.30615893, 0.30575338, 0.33256865, 0.31426498, 0.30090055, 0.3196362, 0.31853753, 0.30953133, 0.34065172, 0.31142056, 0.31455135, 0.32048514, 0.30726683, 0.3071631, 0.31782755, 0.32289612, 0.3209947, 0.32337758, 0.29126, 0.33016896, 0.34801206, 0.35693654, 0.32921097, 0.3104047, 0.32660523, 0.33000433, 0.35063484, 0.30894378, 0.33883256, 0.3441942, 0.3147267, 0.32278806, 0.3100489, 0.35804558, 0.33232227, 0.32092825, 0.32326666, 0.32727432, 0.30953476, 0.31483403, 0.3091946, 0.31184667, 0.31783432, 0.32199082, 0.3382688, 0.29430935, 0.31313154, 0.32176575, 0.3177942, 0.31226483, 0.33242115, 0.31613174, 0.33093503, 0.30671173, 0.33199927, 0.3280201, 0.33088258, 0.3263025, 0.31550583, 0.3095718, 0.31558108, 0.3146267, 0.303545, 0.3125393, 0.32141653, 0.3281509, 0.30572626, 0.30449197, 0.30074236, 0.3311313, 0.33110288, 0.3126324, 0.33044764, 0.30776674, 0.31854436, 0.31750953, 0.33850518, 0.32357013, 0.33016652, 0.31177133, 0.34321147, 0.31514692, 0.29751286, 0.3250296, 0.31141624, 0.31230617, 0.31361276, 0.32914978, 0.31657156, 0.30582413, 0.33806485, 0.33193034, 0.31800693, 0.30604172, 0.32081965, 0.32691416, 0.31378672, 0.3015024, 0.30047426, 0.31288296, 0.32456356, 0.31165096, 0.3215144, 0.32362324, 0.305445, 0.31159154, 0.32003164, 0.30513886, 0.31094778, 0.32588682, 0.32373118, 0.30880553, 0.3308141, 0.30277884, 0.2961588, 0.3230036, 0.33085772, 0.32215652, 0.3174413, 0.33695757, 0.3225509, 0.33164963, 0.3120053, 0.34615633, 0.32397202, 0.33128852, 0.32183716, 0.32406774, 0.32482174, 0.3196013, 0.30993223, 0.33029342, 0.30975097, 0.33409652, 0.3260085, 0.3138711, 0.32578573, 0.33131903, 0.32391462, 0.3197383, 0.3360727, 0.30877468, 0.32669392, 0.31643447, 0.3321424, 0.3242776, 0.32371777, 0.32957265, 0.31199843, 0.2936424, 0.33612502, 0.34404954, 0.31936237, 0.3276031, 0.32552162, 0.3117967, 0.31900483, 0.29994488, 0.31368873, 0.3104037, 0.31648606, 0.3249843, 0.3235483, 0.31391418, 0.3187679, 0.32145593, 0.3003647, 0.32442945, 0.30953693, 0.32337293, 0.30886942, 0.29639375, 0.29267436, 0.33415, 0.31738922, 0.30844828, 0.3237391, 0.32657546, 0.3139051, 0.320094, 0.3359351, 0.31125993, 0.29936528, 0.3219489, 0.31504807, 0.3045215, 0.31638876, 0.3210834, 0.2999484, 0.32853064, 0.3374842, 0.32866564, 0.3215079, 0.31924886, 0.32773435, 0.3188851, 0.22318327, 0.22058912, 0.21275774, 0.22170965, 0.21578044, 0.22997661, 0.22517346, 0.21616085, 0.22953014, 0.2216759, 0.23386818, 0.2039474, 0.22798085, 0.21210425, 0.21831301, 0.23146795, 0.22533777, 0.21192104, 0.22850205, 0.21815103, 0.52576625, 0.54891014, 0.49335146, 0.50650007, 0.5307283, 0.5331145, 0.5159651, 0.53339833, 0.5102275, 0.5290755, 0.5329107, 0.51998717, 0.5411251, 0.51123077, 0.5244222, 0.5430694, 0.5242341, 0.54399055, 0.52075845, 0.52731407, 0.09770771]


# histogram(all_min_v)
# xlims!( 0.0085, 0.01)


#Probabilistic model (SBM) for uncertainty quantification in black-box functions.
@model SBM(xs, ys, Vmin_dist, meanEstParams,stdEstParams) = begin
    parms_mlp ~ MvNormal(zeros(481), 0.3.* ones(481)) #Prior
    v=BBF(xs,ys,parms_mlp)
    ss = 0.001
    for i=1:length(Vmin_dist)
        Vmin_dist[i] ~ truncated(Normal(v, ss),0,0.1)
    end
end;

# Vmin_dist_bbf = all_min_v[1:5]
Vmin_dist_bbf = [0.009470921683100172, 0.009915670967283994, 0.009059485503738892, 0.009672537188321674, 0.009698681270611425]

##### Variational inference tests
# m=SBM(Array(x'), Array(y'),parameters_min_MLP,Vmin_dist_bbf,0.001)
# advi = ADVI(10, 1000)
# q = vi(m, advi);

##### MCMC samples from SBM
N = 3000
ch1 = sample(SBM(Array(x'), Array(y'),Vmin_dist_bbf,mean_est_params,std_est_params), NUTS(0.65), N);




#### results from MCMC sampling

chain_df = DataFrame(ch1)
# Save to CSV


full_path_nm="chain_bnn_umin"*Dates.format(Dates.now(), "_d_u_yyy_H:M:S_")*".csv"
println(full_path_nm)
CSV.write(full_path_nm, chain_df)


# full_path_nm="chain"*Dates.format(Dates.now(), "_d_u_yyy_H:M:S_")*".png"
# println(full_path_nm)
# plot(ch1)
# savefig(full_path_nm)
display(ch1)

full_path_nm="bnn-plot0"*Dates.format(Dates.now(), "_d_u_yyy_H:M:S_")*".png"
println(full_path_nm)
lp, maxInd = findmax(ch1[:lp])
params, _ = ch1.name_map
bestParams = map(x-> ch1[x].data[maxInd], params[1:481])
ppp1=plot(x, cos.(x), seriestype=:line, label="True")
plot!(x, Array(nn_forward(hcat(x...), bestParams)'),
      seriestype=:scatter, label="MAP Estimate")
display(ppp1)
savefig(full_path_nm)

full_path_nm="bnn-plot1"*Dates.format(Dates.now(), "_d_u_yyy_H:M:S_")*".png"
println(full_path_nm)
xPlot = sort(x)
sp = plot()
paramSample=[]
nsize=500
for i in max(1, (maxInd[1]-nsize)):min(N, (maxInd[1]+nsize))
  paramSample = map(x-> ch1[x].data[i], params[1:481])
  plot!(sp, xPlot, Array(nn_forward(hcat(xPlot...), paramSample)'),  alpha = 0.04, label=:none, colour="lightblue")
end
plot!(sp, xPlot, f.(xPlot), seriestype=:scatter, label="Training Data", colour="red")
plot!(xPlot, cos.(xPlot), label="True",w=3, colour="yellow")
plot!(sp, xPlot, Array(nn_forward(hcat(xPlot...), bestParams)'), label="BNN_bestParams", w=3, colour="blue")
display(sp)
savefig(full_path_nm)

full_path_nm="bnn-plot2"*Dates.format(Dates.now(), "_d_u_yyy_H:M:S_")*".png"
println(full_path_nm)
xPlot = sort([x;collect(-7:0.1:3.5)])
sp = plot()
paramSample=[]
nsize=500
for i in max(1, (maxInd[1]-nsize)):min(N, (maxInd[1]+nsize))
  paramSample = map(x-> ch1[x].data[i], params[1:481])
  plot!(sp, xPlot, Array(nn_forward(hcat(xPlot...), paramSample)'),  alpha = 0.05,label=:none, colour="lightblue")
end
plot!(sp, sort(x), f.(sort(x)), seriestype=:scatter, label="Training Data", colour="red")
plot!(xPlot, cos.(xPlot),colour="yellow", w=3,label="True")
plot!(sp, xPlot, Array(nn_forward(hcat(xPlot...), bestParams)'), label="BNN_bestParams", w=3, colour="blue")
display(sp)
savefig(full_path_nm)



full_path_nm="bnn-plot3"*Dates.format(Dates.now(), "_d_u_yyy_H:M:S_")*".png"
println(full_path_nm)
xPlot = sort([x;collect(-10:0.1:10)])
sp = plot()
paramSample=[]
nsize=500
for i in max(1, (maxInd[1]-nsize)):min(N, (maxInd[1]+nsize))
  paramSample = map(x-> ch1[x].data[i], params[1:481])
  plot!(sp, xPlot, Array(nn_forward(hcat(xPlot...), paramSample)'),  alpha = 0.05,label=:none, colour="lightblue")
end
plot!(sp, sort(x), f.(sort(x)), seriestype=:scatter, label="Training Data", colour="red")
plot!(xPlot, cos.(xPlot),colour="yellow", w=3,label="True")
plot!(sp, xPlot, Array(nn_forward(hcat(xPlot...), bestParams)'), label="BNN_bestParams", w=3, colour="blue")
display(sp)
savefig(full_path_nm)



# chain = CSV.read("/home/Umin/empirical_test/chain_bnn_umin_26_Jul_024_13:37:32_.csv", DataFrame)
#
# # Convert chain to DataFrame
# xPlot = sort(x)
# sp = plot()
# chain = DataFrame(ch1)
# nsize=500
# for i=1:size(Array(chain[1:nsize,3:9]))[1]
#   paramSample = Array(chain[1:nsize,3:9])[i,:]
#   plot!(sp, xPlot, Array(nn_forward(hcat(xPlot...), paramSample)'), label=:none, colour="lightblue")
# end
# plot!(sp, xPlot, f.(xPlot), seriestype=:scatter, label="Training Data", colour="red")
# plot!(xPlot, cos.(xPlot), colour="yellow", w=3,label="True")
# display(sp)
#
# #
# # #



# -lambda-vector:~$ julia exp_2.jl
# Vmin_dist_bbf :[0.009470921683100172, 0.009915670967283994, 0.009059485503738892, 0.009672537188321674, 0.009698681270611425]
# ┌ Info: Found initial step size
# └   ϵ = 0.000390625
# Sampling 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| Time: 1 days, 15:30:01
# chain_bnn_umin_29_Jul_024_5:29:47_.csv
# Chains MCMC chain (3000×493×1 Array{Float64, 3}):
#
# Iterations        = 1001:1:4000
# Number of chains  = 1
# Samples per chain = 3000
# Wall duration     = 142202.48 seconds
# Compute duration  = 142202.48 seconds
#
# bnn-plot0_29_Jul_024_5:29:59_.png
# bnn-plot1_29_Jul_024_5:30:4_.png
# ┌ Warning: Assignment to `paramSample` in soft scope is ambiguous because a global variable by the same name exists: `paramSample` will be treated as a new local. Disambiguate by using `local paramSample` to suppress this warning or `global paramSample` to assign to the existing global variable.
# └ @ ~/exp_2.jl:265
# bnn-plot2_29_Jul_024_5:30:8_.png
# ┌ Warning: Assignment to `paramSample` in soft scope is ambiguous because a global variable by the same name exists: `paramSample` will be treated as a new local. Disambiguate by using `local paramSample` to suppress this warning or `global paramSample` to assign to the existing global variable.
# └ @ ~/exp_2.jl:281
# bnn-plot3_29_Jul_024_5:30:12_.png
# ┌ Warning: Assignment to `paramSample` in soft scope is ambiguous because a global variable by the same name exists: `paramSample` will be treated as a new local. Disambiguate by using `local paramSample` to suppress this warning or `global paramSample` to assign to the existing global variable.
# └ @ ~/exp_2.jl:299
# @NRC-lambda-vector:~$ julia exp_2.jl
